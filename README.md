# Naive Auction Bot

Простой Telegram-бот для проведения аукционов с SQLite персистентностью данных.

## Описание

Это standalone сервис для проведения онлайн-аукционов через Telegram. Бот позволяет:
- Просматривать список лотов
- Делать ставки (автоматическое повышение или индивидуальная ставка)
- Отслеживать свои ставки
- Получать уведомления о перебитии ставок
- Админ-функции для управления аукционом

## Технологии

- Python 3.11
- python-telegram-bot 20.7
- SQLite (через aiosqlite)
- Docker

## Локальный запуск

### Требования

- Python 3.11+
- Telegram Bot Token (получить у [@BotFather](https://t.me/BotFather))

### Установка

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Создайте `.env` файл на основе `.env.example`:
```bash
cp .env.example .env
```

3. Отредактируйте `.env` и укажите ваш токен бота:
```
TG_BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz
CREATOR_ID=YOUR_TELEGRAM_USER_ID
```

4. Запустите бота:
```bash
python bot.py
```

База данных `auction.db` будет создана автоматически при первом запуске.

## Деплой на Railway

### Шаг 1: Подготовка

1. Создайте аккаунт на [Railway.app](https://railway.app/)
2. Убедитесь, что ваш репозиторий находится на GitHub

### Шаг 2: Создание проекта

1. Войдите в Railway и нажмите "New Project"
2. Выберите "Deploy from GitHub repo"
3. Выберите ваш репозиторий
4. Railway автоматически обнаружит Dockerfile

### Шаг 3: Настройка переменных окружения

1. Перейдите в раздел "Variables" вашего проекта
2. Добавьте следующие переменные:
   - `TG_BOT_TOKEN` - ваш токен бота от BotFather
   - `CREATOR_ID` - ваш Telegram User ID (опционально, по умолчанию 1337)

### Шаг 4: Настройка персистентности (опционально)

Для сохранения данных между перезапусками:
1. Перейдите в "Settings" → "Volumes"
2. Нажмите "Add Volume"
3. Mount Path: `/app`
4. Это сохранит файл `auction.db` между деплоями

### Шаг 5: Деплой

1. Railway автоматически задеплоит ваш сервис после настройки
2. Проверьте логи в разделе "Deployments" → выберите последний деплой → "View Logs"
3. Вы должны увидеть сообщение: `Bot started successfully`

### Переменные окружения Railway

Railway автоматически предоставляет некоторые переменные, но для polling-бота они не требуются:
- `PORT` - не используется (бот работает через polling, а не webhook)
- `RAILWAY_VOLUME_MOUNT_PATH` - можно использовать для кастомного пути к БД

## Команды бота

### Для пользователей:
- `/start` - начать работу с ботом
- `/auction` - информация об аукционе
- `/info` - информация о боте
- Кнопки в меню:
  - "Показать лоты" - список всех лотов
  - "Показать свои ставки" - ваши текущие ставки

### Для администратора:
- `/delete <bid_id>` - удалить ставку (требуется CREATOR_ID)

## Структура данных

### База данных SQLite

Таблица `bids`:
| Поле | Тип | Описание |
|------|-----|----------|
| id | INTEGER | Автоинкремент, первичный ключ |
| lot_id | INTEGER | ID лота |
| user_id | INTEGER | Telegram User ID |
| amount | REAL | Сумма ставки |
| created_at | TIMESTAMP | Время создания |

### Лоты

Лоты определены в коде (`bot.py`, переменная `auction_lots`) и включают:
- `title` - название лота
- `description` - описание
- `starting_price` - начальная цена
- `min_bid_step` - минимальный шаг ставки
- `image_url` - ссылка на изображение

**Важно:** Для корректной работы Telegram API необходимо использовать прямые ссылки на изображения (например, `https://i.imgur.com/XXX.jpg`), а не ссылки на альбомы (`https://imgur.com/a/XXX`). Текущие ссылки в коде указывают на альбомы и требуют обновления для работы функции отправки изображений.

## Архитектура

```
naive-auction-bot/
├── bot.py              # Основная логика бота
├── database.py         # Слой работы с SQLite
├── requirements.txt    # Python зависимости
├── Dockerfile          # Конфигурация Docker
├── .dockerignore       # Игнорируемые файлы
├── .env.example        # Шаблон конфигурации
├── railway.toml        # Конфигурация Railway
├── QUICKSTART.md       # Быстрый старт
└── README.md           # Этот файл
```

## Graceful Shutdown

Бот корректно обрабатывает сигналы `SIGINT` и `SIGTERM`, что позволяет ему:
- Завершить обработку текущих сообщений
- Закрыть соединения с Telegram API
- Закрыть соединение с БД

Это важно для Railway, который отправляет `SIGTERM` при остановке контейнера.

## Troubleshooting

### Бот не запускается
- Проверьте логи: убедитесь, что `TG_BOT_TOKEN` установлен
- Проверьте валидность токена через BotFather

### База данных не сохраняется между деплоями
- Убедитесь, что настроен Volume в Railway
- Проверьте права доступа к директории `/app`

### Уведомления не приходят
- Пользователь должен хотя бы раз написать боту
- Проверьте логи на ошибки отправки сообщений

## Лицензия

Часть проекта Solguficky Hub.

